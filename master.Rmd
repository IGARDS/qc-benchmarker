---
title: "Master Pipeline"
output:
  html_document: default
  pdf_document: default
date version: May 24, 2019
---

This file is meant to run all processing once the query has been uploaded. It is an .Rmd, but will not be used for display. The primary function is to perform file conversion and searching, with results kept in the workspace for ensuing .Rmd files to use when generating reports. Also we will write 5 .result files to be used to retrieve graphics displayed in middle iframe. These will have a value of 0, 1, 2, 3, or 4.  
processing in progress = 0  
good = 1  
marginal = 2  
bad = 3  
error = 4  
QUERY, OUTPUT_DIR are set at upload  
reference related files (.raw, .mzML, and .interact.pep.xml) should be present in /data/qc-benchmarker-data/

1. Load R packages

```{r Setup libs, echo=FALSE}
library(mzR)
library(MSnbase)
library(scales)
library(XML)
library(pepXMLTab)
library(ggplot2)

```



2. Call reference files, process QUERY, write .result files. In future iterations will perform lite search to determine if HeLa, yeast or E. coli

```{r Setup files, echo=FALSE}
DATA_DIR <- '/data/qc-benchmarker-data/'
REFERENCE <- paste('2018-10-15_HeLa_OTOT',sep='')   # reference name for later use with different file types
AMOUNT_INJECTED <- 200                                       # ng HeLa injected (reference)
SPECTRAST_LIBRARY <- paste(DATA_DIR,'HeLa.splib',sep='')                   # HeLa library
FASTA_FILE <- paste(DATA_DIR,'up000005640.fasta',sep='')                   # sequence database
#MZML_DIR <- ''                                              # working directory is OUTPUT_DIR
#mzml_file <- paste(MZML_DIR,'/',QUERY,'.mzML',sep='')       # didn't use this abbreviation



# convert query to mzML
system(paste('wine msconvert', paste(OUTPUT_DIR,'/../',QUERY,'.raw',sep=''),'-v --mzML -o',OUTPUT_DIR))

query_file <- openMSfile(paste(QUERY, '.mzML', sep=''))
make <- instrumentInfo(query_file)$manufacturer
model <- instrumentInfo(query_file)$model
# cat('Query file is', make, model)

# write .result files as "processing in progress"
system('echo 0 > sample.result')
system('echo 0 > lc.result')
system('echo 0 > source.result')
system('echo 0 > ms1.result')
system('echo 0 > ms2.result')

```
